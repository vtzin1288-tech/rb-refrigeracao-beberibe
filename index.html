<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>RB Refrigeração Beberibe</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; background: #f0f2f5; margin:0; padding:0; }
header { background: #0b5ed7; color: white; padding: 20px; text-align:center; }
section { padding: 20px; }
.card { background: white; padding:20px; border-radius:8px; box-shadow:0 0 15px rgba(0,0,0,0.2); margin-bottom:20px; }
input, button { width:100%; padding:12px; margin-top:10px; font-size:16px; }
button { background:#0b5ed7; color:white; border:none; border-radius:5px; cursor:pointer; }
button:hover { opacity:0.9; }
table { width:100%; border-collapse: collapse; margin-top:10px; font-size:14px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#0b5ed7; color:white; }
#funcCard, #bossCard { display:none; }
.top-button { float:right; margin-bottom:10px; width:auto; padding:8px 16px; margin-left:5px; }
</style>
</head>
<body>

<header>
<h1>RB Refrigeração Beberibe</h1>
<p>Sistema de Controle de Horários</p>
</header>

<!-- LOGIN -->
<section class="card" id="loginCard">
<h3>Login</h3>
<input type="text" id="userCode" placeholder="Digite seu código (ex: RB01 ou ADM01)">
<input type="text" id="userName" placeholder="Digite seu nome (obrigatório para funcionários)">
<button onclick="login()">Entrar</button>
<p id="loginMsg" style="color:red;"></p>
</section>

<!-- ÁREA DO FUNCIONÁRIO -->
<section class="card" id="funcCard">
<h3>Bem-vindo, <span id="funcNameDisplay"></span></h3>
<button class="top-button" id="verRegistrosBtn" onclick="displayUserRecords()">Ver Todos os Registros</button>
<button class="top-button" id="deleteRecordsBtn" onclick="deleteUserRecords()">Apagar Todos Meus Registros</button>

<table>
<tr>
<th>Entrada</th>
<th>Saída Almoço</th>
<th>Retorno Almoço</th>
<th>Saída Trabalho</th>
<th>Horas Extras</th>
</tr>
<tr>
<td><input type="time" id="entrada"></td>
<td><input type="time" id="saidaAlmoco"></td>
<td><input type="time" id="retornoAlmoco"></td>
<td><input type="time" id="saida"></td>
<td><input type="time" id="horaExtra"></td>
</tr>
</table>
<button onclick="saveRecord()">Salvar Registro</button>
<div id="userRecords"></div>
</section>

<!-- ÁREA DO PATRÃO -->
<section class="card" id="bossCard">
<h3>Área do Patrão</h3>
<button onclick="viewAllEmployeeRecords()">Ver Todos os Registros de Funcionários</button>
<button id="deleteAllBtn" onclick="deleteAllRecords()">Apagar Todos os Registros de Todos</button>
<div id="allRecords"></div>
</section>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
// ========== CONFIGURAÇÃO DO FIREBASE ==========
const firebaseConfig = {
  apiKey: "COLE_AQUI",
  authDomain: "COLE_AQUI",
  projectId: "COLE_AQUI",
  storageBucket: "COLE_AQUI",
  messagingSenderId: "COLE_AQUI",
  appId: "COLE_AQUI"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ========== CÓDIGOS VÁLIDOS ==========
const employeeCodes = [];
for(let i=1;i<=100;i++){ employeeCodes.push('RB'+String(i).padStart(2,'0')); }
const bossCode = 'ADM01';

// ========== VARIÁVEIS CONFIRMAÇÃO DUPLA ==========
let confirmDeleteUser = false;
let confirmDeleteAll = false;

// ========== LOGIN ==========
async function login(){
    const code = document.getElementById('userCode').value.toUpperCase();
    const nameInput = document.getElementById('userName').value.trim();
    const loginMsg = document.getElementById('loginMsg');

    if(code === bossCode){
        document.getElementById('loginCard').style.display='none';
        document.getElementById('bossCard').style.display='block';
        loginMsg.innerText = '';
        return;
    } 

    if(!employeeCodes.includes(code)){
        loginMsg.innerText = 'Código inválido!';
        return;
    }

    if(!nameInput){
        loginMsg.innerText = 'O nome é obrigatório!';
        return;
    }

    // Verificar se já existe nome registrado
    const docRef = db.collection('funcionarios').doc(code);
    const doc = await docRef.get();
    if(doc.exists){
        const storedName = doc.data().nome;
        if(storedName !== nameInput){
            loginMsg.innerText = 'Nome não corresponde ao registrado!';
            return;
        }
    } else {
        // Primeiro login: salva o nome
        await docRef.set({nome: nameInput});
    }

    document.getElementById('loginCard').style.display='none';
    document.getElementById('funcCard').style.display='block';
    document.getElementById('funcNameDisplay').innerText = nameInput;
    displayUserRecords();
    loginMsg.innerText = '';
}

// ========== FUNCIONÁRIO: SALVAR REGISTRO ==========
function saveRecord(){
    const code = document.getElementById('userCode').value.toUpperCase();
    const name = document.getElementById('userName').value;
    const entrada = document.getElementById('entrada').value;
    const saidaAlmoco = document.getElementById('saidaAlmoco').value;
    const retornoAlmoco = document.getElementById('retornoAlmoco').value;
    const saida = document.getElementById('saida').value;
    const horaExtra = document.getElementById('horaExtra').value;

    if(!entrada || !saidaAlmoco || !retornoAlmoco || !saida){
        alert('Preencha todos os horários obrigatórios!');
        return;
    }

    db.collection('funcionarios').doc(code).collection('registros').add({
        nome: name,
        entrada, saidaAlmoco, retornoAlmoco, saida, horaExtra,
        data: new Date().toLocaleString()
    }).then(()=>{
        displayUserRecords();
        alert('Registro salvo com sucesso!');
    });
}

// ========== FUNCIONÁRIO: MOSTRAR REGISTROS ==========
function displayUserRecords(){
    const code = document.getElementById('userCode').value.toUpperCase();
    const div = document.getElementById('userRecords');
    div.innerHTML = '<p>Carregando registros...</p>';
    db.collection('funcionarios').doc(code).collection('registros').orderBy('data','desc').get()
    .then(snapshot=>{
        if(snapshot.empty){
            div.innerHTML = 'Nenhum registro encontrado.';
            return;
        }
        let html = '<table><tr><th>Entrada</th><th>Saída Almoço</th><th>Retorno Almoço</th><th>Saída Trabalho</th><th>Horas Extras</th><th>Data</th></tr>';
        snapshot.forEach(doc=>{
            const r = doc.data();
            html += `<tr>
            <td>${r.entrada}</td>
            <td>${r.saidaAlmoco}</td>
            <td>${r.retornoAlmoco}</td>
            <td>${r.saida}</td>
            <td>${r.horaExtra}</td>
            <td>${r.data}</td>
            </tr>`;
        });
        html += '</table>';
        div.innerHTML = html;
    });
}

// ========== FUNCIONÁRIO: APAGAR TODOS REGISTROS ==========
function deleteUserRecords(){
    if(!confirmDeleteUser){
        confirmDeleteUser = true;
        document.getElementById('deleteRecordsBtn').innerText = 'Clique novamente para confirmar';
    } else {
        const code = document.getElementById('userCode').value.toUpperCase();
        db.collection('funcionarios').doc(code).collection('registros').get().then(snapshot=>{
            snapshot.forEach(doc=> doc.ref.delete() );
        }).then(()=>{
            confirmDeleteUser = false;
            document.getElementById('deleteRecordsBtn').innerText = 'Apagar Todos Meus Registros';
            displayUserRecords();
            alert('Seus registros foram apagados. Patrão ainda pode ver registros antigos.');
        });
    }
}

// ========== PATRÃO: VER TODOS OS REGISTROS ==========
function viewAllEmployeeRecords(){
    const div = document.getElementById('allRecords');
    div.innerHTML = '<p>Carregando registros...</p>';
    let html = '';
    employeeCodes.forEach(code=>{
        db.collection('funcionarios').doc(code).get().then(doc=>{
            if(!doc.exists) return;
            const storedName = doc.data().nome;
            db.collection('funcionarios').doc(code).collection('registros').orderBy('data','desc').get().then(snapshot=>{
                if(!snapshot.empty){
                    html += `<h4>${storedName}</h4><table><tr><th>Nome</th><th>Entrada</th><th>Saída Almoço</th><th>Retorno Almoço</th><th>Saída Trabalho</th><th>Horas Extras</th><th>Data</th></tr>`;
                    snapshot.forEach(r=>{
                        const rec = r.data();
                        html += `<tr>
                        <td>${rec.nome}</td>
                        <td>${rec.entrada}</td>
                        <td>${rec.saidaAlmoco}</td>
                        <td>${rec.retornoAlmoco}</td>
                        <td>${rec.saida}</td>
                        <td>${rec.horaExtra}</td>
                        <td>${rec.data}</td>
                        </tr>`;
                    });
                    html += '</table>';
                    div.innerHTML = html;
                }
            });
        });
    });
}

// ========== PATRÃO: APAGAR TODOS OS REGISTROS ==========
function deleteAllRecords(){
    if(!confirmDeleteAll){
        confirmDeleteAll = true;
        document.getElementById('deleteAllBtn').innerText = 'Clique novamente para confirmar';
    } else {
        employeeCodes.forEach(code=>{
            db.collection('funcionarios').doc(code).collection('registros').get().then(snapshot=>{
                snapshot.forEach(doc=> doc.ref.delete() );
            });
        });
        confirmDeleteAll = false;
        document.getElementById('deleteAllBtn').innerText = 'Apagar Todos os Registros de Todos';
        document.getElementById('allRecords').innerHTML = '';
        alert('Todos os registros de todos os funcionários foram apagados.');
    }
}
</script>

</body>
    </html>

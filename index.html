<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>RB Refrigeração Beberibe</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; background: #f0f2f5; margin:0; padding:0; }
header { background: #0b5ed7; color: white; padding: 20px; text-align:center; }
section { padding: 20px; }
.card { background: white; padding:20px; border-radius:8px; box-shadow:0 0 15px rgba(0,0,0,0.2); margin-bottom:20px; }
input, button { width:100%; padding:12px; margin-top:10px; font-size:16px; }
button { background:#0b5ed7; color:white; border:none; border-radius:5px; cursor:pointer; }
button:hover { opacity:0.9; }
table { width:100%; border-collapse: collapse; margin-top:10px; font-size:14px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#0b5ed7; color:white; }
td.entrada { background: #d4edda; }
td.saida { background: #f8d7da; }
td.almoco { background: #fff3cd; }
td.horaExtra { background: #ffeeba; }
</style>
</head>
<body>

<header>
<h1>RB Refrigeração Beberibe</h1>
<p>Sistema de Controle de Horários</p>
</header>

<!-- LOGIN -->
<section id="loginCard" class="card">
<h3>Login</h3>
<input type="text" id="codigo" placeholder="Digite seu Código (ex: RB01 ou ADM01)">
<input type="text" id="nomeOpcional" placeholder="Digite seu Nome (opcional para funcionários)">
<button onclick="login()">Entrar</button>
<p id="loginMsg"></p>
</section>

<!-- ÁREA DO FUNCIONÁRIO -->
<section id="funcCard" class="card" style="display:none">
<h3>Bem-vindo <span id="funcNome"></span></h3>
<p>Registre seu expediente:</p>
<table>
<tr>
<th>Entrada</th>
<th>Saída Almoço</th>
<th>Retorno Almoço</th>
<th>Saída Trabalho</th>
<th>Horas Extras</th>
</tr>
<tr>
<td><input type="time" id="entrada"></td>
<td><input type="time" id="saidaAlmoco"></td>
<td><input type="time" id="retornoAlmoco"></td>
<td><input type="time" id="saidaTrabalho"></td>
<td><input type="time" id="horaExtra"></td>
</tr>
</table>
<button onclick="salvarRegistro()">Salvar Registro</button>
<button onclick="apagarRegistrosFuncionario()">Apagar Todos os Meus Registros</button>

<h4>Seus registros:</h4>
<table id="tabelaRegistrosFuncionario">
<tr><th>Data</th><th>Entrada</th><th>Saída Almoço</th><th>Retorno Almoço</th><th>Saída Trabalho</th><th>Horas Extras</th></tr>
</table>
</section>

<!-- ÁREA DO PATRÃO -->
<section id="bossCard" class="card" style="display:none">
<h3>Área do Patrão</h3>
<button onclick="verTodosRegistros()">Ver Todos os Registros de Funcionários</button>
<button onclick="apagarTodosRegistros()">Apagar Todos os Registros de Todos</button>
<div id="todosRegistros"></div>
</section>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"></script>
<script>
const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_AUTH_DOMAIN",
    projectId: "SEU_PROJECT_ID",
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let usuarioAtual = "";
let nomeAtual = "";

// LOGIN
async function login() {
    const codigo = document.getElementById("codigo").value.trim();
    const nome = document.getElementById("nomeOpcional").value.trim();
    const msg = document.getElementById("loginMsg");
    if (!codigo) return msg.innerText = "Digite o código!";

    // Patrão
    if (codigo === "ADM01") {
        usuarioAtual = "ADM01";
        nomeAtual = "ADM";
        document.getElementById("loginCard").style.display = "none";
        document.getElementById("bossCard").style.display = "block";
        return;
    }

    // Funcionário RB01–RB100
    const validCodes = Array.from({length:100}, (_,i)=> "RB" + String(i+1).padStart(2,"0"));
    if (!validCodes.includes(codigo)) return msg.innerText = "Código inválido!";

    const docRef = db.collection("funcionarios").doc(codigo);
    const docSnap = await docRef.get();
    
    // Primeiro login -> salva nome
    if (!docSnap.exists || !docSnap.data().nome) {
        if (!nome) return msg.innerText = "Digite um nome opcional para registrar!";
        await docRef.set({nome: nome, registros: []}, {merge:true});
        nomeAtual = nome;
    } else {
        const nomeSalvo = docSnap.data().nome;
        if (!nome || nome !== nomeSalvo) return msg.innerText = "Nome não corresponde ao registrado!";
        nomeAtual = nomeSalvo;
    }

    usuarioAtual = codigo;
    document.getElementById("loginCard").style.display = "none";
    document.getElementById("funcCard").style.display = "block";
    document.getElementById("funcNome").innerText = nomeAtual;
    carregarRegistrosFuncionario();
}

// SALVAR REGISTRO
async function salvarRegistro() {
    const entrada = document.getElementById("entrada").value;
    const saidaAlmoco = document.getElementById("saidaAlmoco").value;
    const retornoAlmoco = document.getElementById("retornoAlmoco").value;
    const saidaTrabalho = document.getElementById("saidaTrabalho").value;
    const horaExtra = document.getElementById("horaExtra").value;
    if (!entrada || !saidaAlmoco || !retornoAlmoco || !saidaTrabalho) return alert("Preencha todos os horários!");

    const docRef = db.collection("funcionarios").doc(usuarioAtual);
    const docSnap = await docRef.get();
    let registros = docSnap.data().registros || [];
    const dataAtual = new Date().toLocaleString("pt-BR");
    registros.push({data:dataAtual, entrada, saidaAlmoco, retornoAlmoco, saidaTrabalho, horaExtra});
    await docRef.update({registros});
    alert("Registro salvo!");
    carregarRegistrosFuncionario();
}

// CARREGAR REGISTROS DO FUNCIONÁRIO
async function carregarRegistrosFuncionario() {
    const docSnap = await db.collection("funcionarios").doc(usuarioAtual).get();
    const registros = docSnap.data().registros || [];
    const tabela = document.getElementById("tabelaRegistrosFuncionario");
    tabela.innerHTML = "<tr><th>Data</th><th>Entrada</th><th>Saída Almoço</th><th>Retorno Almoço</th><th>Saída Trabalho</th><th>Horas Extras</th></tr>";
    registros.forEach(r => {
        const row = `<tr><td>${r.data}</td><td>${r.entrada}</td><td>${r.saidaAlmoco}</td><td>${r.retornoAlmoco}</td><td>${r.saidaTrabalho}</td><td>${r.horaExtra}</td></tr>`;
        tabela.innerHTML += row;
    });
}

// APAGAR REGISTROS DO FUNCIONÁRIO
async function apagarRegistrosFuncionario() {
    if(!confirm("Deseja apagar todos os seus registros?")) return;
    await db.collection("funcionarios").doc(usuarioAtual).update({registros: []});
    carregarRegistrosFuncionario();
    alert("Todos os seus registros foram apagados!");
}

// ÁREA DO PATRÃO - VER TODOS REGISTROS
async function verTodosRegistros() {
    const col = await db.collection("funcionarios").get();
    const div = document.getElementById("todosRegistros");
    div.innerHTML = "";
    col.forEach(doc => {
        const data = doc.data();
        if(data.registros && data.registros.length > 0){
            let tabela = `<h4>${data.nome}</h4><table><tr><th>Nome</th><th>Entrada</th><th>Saída Almoço</th><th>Retorno Almoço</th><th>Saída Trabalho</th><th>Horas Extras</th></tr>`;
            data.registros.forEach(r => {
                tabela += `<tr><td>${data.nome}</td><td>${r.entrada}</td><td>${r.saidaAlmoco}</td><td>${r.retornoAlmoco}</td><td>${r.saidaTrabalho}</td><td>${r.horaExtra}</td></tr>`;
            });
            tabela += "</table>";
            div.innerHTML += tabela;
        }
    });
}

// PATRÃO - APAGAR TODOS REGISTROS
async function apagarTodosRegistros() {
    if(!confirm("Deseja apagar todos os registros de todos os funcionários?")) return;
    const col = await db.collection("funcionarios").get();
    col.forEach(doc => {
        db.collection("funcionarios").doc(doc.id).update({registros: []});
    });
    document.getElementById("todosRegistros").innerHTML = "";
    alert("Todos os registros de todos os funcionários foram apagados!");
}

// ===== Botão secreto temporário para resetar nome =====
function criarBotaoResetNome() {
    const btn = document.createElement("button");
    btn.innerText = "Resetar Nome Temporário";
    btn.style.position = "fixed";
    btn.style.bottom = "10px";
    btn.style.right = "10px";
    btn.style.padding = "10px";
    btn.style.background = "#dc3545";
    btn.style.color = "white";
    btn.style.border = "none";
    btn.style.borderRadius = "5px";
    btn.style.zIndex = "9999";
    btn.style.cursor = "pointer";

    btn.onclick = async function () {
        const codigo = prompt("Digite o código que quer resetar (ex: RB01 ou ADM01):");
        if (!codigo) return alert("Código inválido!");
        try {
            await db.collection("funcionarios").doc(codigo).update({ nome: "" });
            alert("Nome resetado com sucesso! Agora é só entrar novamente e cadastrar o nome.");
        } catch (err) {
            console.error(err);
            alert("Erro ao resetar o nome. Verifique se o código existe.");
        }
    };

    document.body.appendChild(btn);
}

criarBotaoResetNome();

</script>
</body>
</html>
